<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoSlides Preferences</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .preferences-container {
            max-width: 650px;
            margin: 20px auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .preferences-header {
            background-color: #f9f9f9;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
        }
        
        .preferences-header h1 {
            margin: 0;
            font-size: 18px;
            font-weight: 500;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #eee;
            background-color: #f9f9f9;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            border-bottom: 2px solid transparent;
        }
        
        .tab.active {
            border-bottom: 2px solid #0078d7;
            color: #0078d7;
            background-color: white;
        }
        
        .tab:hover:not(.active) {
            background-color: #eaeaea;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .preference-item {
            margin-bottom: 20px;
        }
        
        .preference-item label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }
        
        .preference-item input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        
        .help-text {
            color: #777;
            font-size: 12px;
            margin-top: 5px;
        }

        .preference-item label:has(input[type="checkbox"]) + .help-text {
            margin-left: 24px;
        }
        
        .buttons-container {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 15px 20px;
            background-color: #f9f9f9;
            border-top: 1px solid #eee;
        }
        
        button {
            padding: 8px 16px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background-color: #f0f0f0;
            cursor: pointer;
        }
        
        button:hover {
            background-color: #e8e8e8;
        }
        
        #btnSave {
            background-color: #0078d7;
            color: white;
            border-color: #0067b8;
        }
        
        #btnSave:hover {
            background-color: #0067b8;
        }
        
        /* For settings that use selects/inputs other than checkboxes */
        .preference-item select,
        .preference-item input[type="number"],
        .preference-item input[type="text"] {
            box-sizing: border-box;
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin-top: 5px;
        }

        /* For labels that don't have checkboxes inside */
        .preference-item label:not(:has(input[type="checkbox"])) {
            display: block;
        }

        /* Placeholder for future categories that may be empty */
        .coming-soon {
            color: #999;
            font-style: italic;
            padding: 20px 0;
            text-align: center;
        }

        .preference-section {
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .preference-section h3 {
            font-size: 16px;
            margin-top: 0;
            margin-bottom: 15px;
            color: #444;
        }
        
        .buttons-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .buttons-group button {
            flex: 1;
            padding: 8px 16px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background-color: #f0f0f0;
            cursor: pointer;
        }
        
        .buttons-group button:hover {
            background-color: #e8e8e8;
        }

        .code-editor-container {
            position: relative;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
            background-color: #f8f8f8;
        }
        
        #blockingRules {
            width: 100%;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            padding: 8px;
            font-size: 12px;
            border: none;
            resize: vertical;
            background-color: #f8f8f8;
            color: #333;
            line-height: 1.5;
            tab-size: 4;
            overflow-x: auto;
            white-space: nowrap;
        }
        
        .rules-buttons {
            display: flex;
            gap: 10px;
        }
        
        .rules-buttons button {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="preferences-container">
        <div class="preferences-header">
            <h1>AutoSlides Preferences</h1>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="general">General</div>
            <div class="tab" data-tab="capture">Capture Strategy</div>
            <div class="tab" data-tab="profiles">Optimization Profiles</div>
            <div class="tab" data-tab="automation">Website Automation</div>
        </div>
        
        <!-- General Tab -->
        <div class="tab-content active" id="general-tab">
            <div class="preference-item">
                <label>
                    <input type="checkbox" id="allowBackgroundRunning">
                    Keep running in background
                </label>
                <div class="help-text">
                    Prevents the system from sleeping while AutoSlides is running. 
                    Useful for long automated capture sessions.
                </div>
            </div>
            
            <div class="preference-section">
                <h3>Cache Management</h3>
                
                <div class="preference-item">
                    <label for="cacheCleanInterval">Auto-clean interval (minutes):</label>
                    <input type="number" id="cacheCleanInterval" min="0" max="60" step="5" value="15" />
                    <div class="help-text">Set to 0 to disable auto-cleaning</div>
                </div>
                
                <div class="buttons-group">
                    <button id="btnClearCookies">Clear Cookies</button>
                    <button id="btnClearAll">Clear All Data</button>
                </div>
            </div>
            <!-- Other general settings will be added here -->
        </div>
        
        <!-- Capture Strategy Tab -->
        <div class="tab-content" id="capture-tab">
            <div class="coming-soon">
                Capture Strategy settings will appear here in future updates.
            </div>
        </div>
        
        <!-- Optimization Profiles Tab -->
        <div class="tab-content" id="profiles-tab">
            <div class="preference-section">
                <h3>Profile Management</h3>
                <div class="preference-item">
                    <label for="newProfileName">New Profile Name:</label>
                    <input type="text" id="newProfileName" placeholder="Enter profile name">
                    <button id="btnCreateProfile">Create New Profile</button>
                </div>
            </div>
            
            <div id="profilesContainer">
                <!-- Default profiles are not displayed, only non-default profiles -->
                <!-- Each profile section will be dynamically generated via JavaScript -->
            </div>
            
            <template id="profileTemplate">
                <div class="profile-section" data-profile-id="">
                    <div class="profile-header">
                        <h3 class="profile-name"></h3>
                        <button class="btnDeleteProfile">Delete</button>
                    </div>
                    
                    <!-- Basic Configuration -->
                    <div class="profile-config">
                        <h4>Basic Configuration</h4>
                        <div class="preference-item">
                            <label for="profileElementSelector">Element selector:</label>
                            <input type="text" class="profileElementSelector" placeholder="#video_id_topPlayer_html5_api">
                            <div class="help-text">Only the selected element will be captured</div>
                        </div>
                        
                        <div class="preference-item">
                            <label for="profileUrlPattern">URL patterns:</label>
                            <input type="text" class="profileUrlPattern" placeholder="example.com/video">
                            <div class="help-text">Space-separated patterns to auto-select this profile</div>
                        </div>
                    </div>
                    
                    <!-- Automation Settings -->
                    <div class="profile-automation">
                        <h4>Automation Settings</h4>
                        
                        <!-- End Detection Settings -->
                        <div class="preference-item">
                            <label>
                                <input type="checkbox" class="profileAutoDetectEnd"> 
                                Auto-detect playback end
                            </label>
                            <div class="help-text">Auto-stop capture when playback ends</div>
                        </div>
                        
                        <div class="preference-item">
                            <label for="profileEndDetectionSelector">End detection selector:</label>
                            <input type="text" class="profileEndDetectionSelector" placeholder=".player-ended-poster">
                        </div>
                        
                        <!-- Playback Settings -->
                        <div class="preference-item">
                            <label>
                                <input type="checkbox" class="profileAutoStartPlayback"> 
                                Auto-start playback
                            </label>
                            <div class="help-text">Automatically click play button</div>
                        </div>
                        
                        <div class="preference-item">
                            <label for="profilePlayButtonSelector">Play button selector:</label>
                            <input type="text" class="profilePlayButtonSelector" placeholder=".play-button">
                        </div>
                        
                        <div class="preference-item">
                            <label for="profileCountdownSelector">Countdown selector:</label>
                            <input type="text" class="profileCountdownSelector" placeholder=".countdown">
                            <div class="help-text">Element containing countdown before video starts</div>
                        </div>
                        
                        <!-- Speed Settings -->
                        <div class="preference-item">
                            <label>
                                <input type="checkbox" class="profileAutoAdjustSpeed"> 
                                Auto-adjust playback speed
                            </label>
                        </div>
                        
                        <div class="preference-item">
                            <label for="profileSpeedSelector">Speed selector:</label>
                            <input type="text" class="profileSpeedSelector" placeholder="#video_element">
                        </div>
                        
                        <div class="preference-item">
                            <label for="profilePlaybackSpeed">Default playback speed:</label>
                            <select class="profilePlaybackSpeed">
                                <option value="1.0">1.0x</option>
                                <option value="1.5">1.5x</option>
                                <option value="2.0">2.0x</option>
                                <option value="2.5">2.5x</option>
                                <option value="3.0">3.0x</option>
                                <option value="4.0">4.0x</option>
                                <option value="5.0">5.0x</option>
                            </select>
                        </div>
                        
                        <!-- Title Detection Settings -->
                        <div class="preference-item">
                            <label>
                                <input type="checkbox" class="profileAutoDetectTitle"> 
                                Auto-detect title
                            </label>
                            <div class="help-text">Auto-detect info and create subfolders</div>
                        </div>
                        
                        <div class="preference-item">
                            <label for="profileCourseTitleSelector">Course title selector:</label>
                            <input type="text" class="profileCourseTitleSelector" placeholder=".course-title">
                        </div>
                        
                        <div class="preference-item">
                            <label for="profileSessionInfoSelector">Session info selector:</label>
                            <input type="text" class="profileSessionInfoSelector" placeholder=".session-info">
                        </div>
                        
                        <!-- Error Handling Settings -->
                        <div class="preference-item">
                            <label>
                                <input type="checkbox" class="profileAutoRetryError"> 
                                Auto-retry on error
                            </label>
                            <div class="help-text">Automatically retry when errors occur</div>
                        </div>
                        
                        <div class="preference-item">
                            <label for="profileErrorSelector">Error selector:</label>
                            <input type="text" class="profileErrorSelector" placeholder=".error-message">
                        </div>
                        
                        <div class="preference-item">
                            <label for="profileMaxRetryAttempts">Max retry attempts:</label>
                            <input type="number" class="profileMaxRetryAttempts" min="1" max="10" value="3">
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>
        
        <!-- Website Automation Tab -->
        <div class="tab-content" id="automation-tab">
            <div class="preference-section">
                <h3>Element Blocking Rules</h3>
                <p class="help-text">AdGuard-like rules (one per line)</p>
                <div class="code-editor-container">
                    <textarea id="blockingRules" rows="8" spellcheck="false" wrap="off"></textarea>
                </div>
            </div>
        </div>
        
        <div class="buttons-container">
            <button id="btnDefault">Restore Defaults</button>
            <button id="btnCancel">Cancel</button>
            <button id="btnSave">Save</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Tab switching logic
            const tabs = document.querySelectorAll('.tab');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs and content
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    tab.classList.add('active');
                    
                    // Show corresponding content
                    const tabName = tab.getAttribute('data-tab');
                    document.getElementById(`${tabName}-tab`).classList.add('active');
                });
            });

            // Default rules
            const DEFAULT_RULES = `yanhekt.cn###root > div.app > div.sidebar-open:first-child
yanhekt.cn###root > div.app > div.BlankLayout_layout__kC9f3:last-child > div.ant-spin-nested-loading:nth-child(2) > div.ant-spin-container > div.index_liveWrapper__YGcpO > div.index_userlist__T-6xf:last-child > div.index_staticContainer__z3yt-
yanhekt.cn###ai-bit-shortcut
yanhekt.cn##div#ai-bit-animation-modal`;
            
            // Preference elements
            const allowBackgroundRunning = document.getElementById('allowBackgroundRunning');
            const cacheCleanInterval = document.getElementById('cacheCleanInterval');
            const btnClearCookies = document.getElementById('btnClearCookies');
            const btnClearAll = document.getElementById('btnClearAll');
            const blockingRules = document.getElementById('blockingRules');
            const btnApplyRules = document.getElementById('btnApplyRules');
            const btnResetRules = document.getElementById('btnResetRules');
            const btnSave = document.getElementById('btnSave');
            const btnCancel = document.getElementById('btnCancel');
            const btnDefault = document.getElementById('btnDefault');

            // Enhance the blocking rules text area for code-like behavior
            function enhanceBlockingRulesEditor() {
                // Enable tab key in the textarea (instead of changing focus)
                blockingRules.addEventListener('keydown', function(e) {
                    if (e.key === 'Tab') {
                        e.preventDefault();
                        
                        // Insert a tab character at the cursor position
                        const start = this.selectionStart;
                        const end = this.selectionEnd;
                        
                        this.value = this.value.substring(0, start) + '    ' + this.value.substring(end);
                        
                        // Put the cursor after the tab
                        this.selectionStart = this.selectionEnd = start + 4;
                    }
                });
            }
            
            // Load current preferences
            try {
                const config = await window.electronAPI.getConfig();
                allowBackgroundRunning.checked = config.allowBackgroundRunning || false;
                cacheCleanInterval.value = config.cacheCleanInterval || 15;
                
                // Load blocking rules
                const rules = await window.electronAPI.getBlockingRules();
                blockingRules.value = rules || DEFAULT_RULES;
                enhanceBlockingRulesEditor();
            } catch (error) {
                console.error('Failed to load preferences:', error);
            }

            // Clear cookies handler
            btnClearCookies.addEventListener('click', async () => {
                try {
                    btnClearCookies.disabled = true;
                    const result = await window.electronAPI.clearCookies();
                    btnClearCookies.disabled = false;
                    
                    if (result.success) {
                        alert('Cookies cleared successfully');
                    } else {
                        alert('Failed to clear cookies');
                    }
                } catch (error) {
                    console.error('Error clearing cookies:', error);
                    btnClearCookies.disabled = false;
                    alert('Error clearing cookies: ' + error.message);
                }
            });

            // Clear all data handler
            btnClearAll.addEventListener('click', async () => {
                try {
                    btnClearAll.disabled = true;
                    const result = await window.electronAPI.clearAllData();
                    btnClearAll.disabled = false;
                    
                    if (result.success) {
                        alert('All data cleared successfully');
                    } else {
                        alert('Failed to clear all data');
                    }
                } catch (error) {
                    console.error('Error clearing all data:', error);
                    btnClearAll.disabled = false;
                    alert('Error clearing all data: ' + error.message);
                }
            });
            
            // Save button handler
            btnSave.addEventListener('click', async () => {
            try {
                // Get the current config first
                const config = await window.electronAPI.getConfig();
                
                // Update only the preferences-related settings
                const updatedConfig = {
                    ...config,
                    allowBackgroundRunning: allowBackgroundRunning.checked,
                    cacheCleanInterval: parseInt(cacheCleanInterval.value, 10)
                };
                
                // Save the updated config
                await window.electronAPI.saveConfig(updatedConfig);
                
                // Save blocking rules separately and apply them
                await window.electronAPI.saveBlockingRules(blockingRules.value);
                await window.electronAPI.applyBlockingRules();
                
                // Update background running state
                if (allowBackgroundRunning.checked) {
                    await window.electronAPI.enableBackgroundRunning();
                } else {
                    await window.electronAPI.disableBackgroundRunning();
                }
                
                // Close the window
                window.close();
            } catch (error) {
                console.error('Failed to save preferences:', error);
                alert('Failed to save preferences: ' + error.message);
            }
        });
            
            // Cancel button handler
            btnCancel.addEventListener('click', () => {
                window.close();
            });
            
            // Default button handler
            btnDefault.addEventListener('click', async () => {
                // Set to default values
                allowBackgroundRunning.checked = false;
                cacheCleanInterval.value = 15;
                blockingRules.value = DEFAULT_RULES;
                
                // When more preferences are added, reset them to defaults here
            });

            // Profiles related elements
            const profilesContainer = document.getElementById('profilesContainer');
            const profileTemplate = document.getElementById('profileTemplate');
            const newProfileName = document.getElementById('newProfileName');
            const btnCreateProfile = document.getElementById('btnCreateProfile');
            
            // Global buttons
            const btnRestoreDefaults = document.getElementById('btnRestoreDefaults');
            
            let profiles = {};
            let hasChanges = false;
            
            // Load all profiles from configuration
            async function loadAllProfiles() {
                try {
                    const config = await window.electronAPI.getConfig();
                    profiles = config.siteProfiles || {};
                    
                    // Clear existing profiles container
                    profilesContainer.innerHTML = '';
                    
                    // Create UI for each non-default profile
                    for (const [id, profile] of Object.entries(profiles)) {
                        if (id !== 'default') {
                            createProfileSection(id, profile);
                        }
                    }
                } catch (error) {
                    console.error('Failed to load profiles:', error);
                    alert('Failed to load profiles: ' + error.message);
                }
            }
            
            // Create settings section for a single profile
            function createProfileSection(profileId, profile) {
                // Clone template
                const profileSection = profileTemplate.content.cloneNode(true).querySelector('.profile-section');
                
                // Set profile ID
                profileSection.dataset.profileId = profileId;
                
                // Set profile name
                const profileName = profileSection.querySelector('.profile-name');
                profileName.textContent = profile.name || profileId;
                
                // Set basic attributes
                const elementSelector = profileSection.querySelector('.profileElementSelector');
                const urlPattern = profileSection.querySelector('.profileUrlPattern');
                elementSelector.value = profile.elementSelector || '';
                urlPattern.value = profile.urlPattern || '';
                
                // Set automation attributes
                const automation = profile.automation || {};
                const autoDetectEnd = profileSection.querySelector('.profileAutoDetectEnd');
                const endDetectionSelector = profileSection.querySelector('.profileEndDetectionSelector');
                const autoStartPlayback = profileSection.querySelector('.profileAutoStartPlayback');
                const playButtonSelector = profileSection.querySelector('.profilePlayButtonSelector');
                const countdownSelector = profileSection.querySelector('.profileCountdownSelector');
                const autoAdjustSpeed = profileSection.querySelector('.profileAutoAdjustSpeed');
                const speedSelector = profileSection.querySelector('.profileSpeedSelector');
                const playbackSpeed = profileSection.querySelector('.profilePlaybackSpeed');
                const autoDetectTitle = profileSection.querySelector('.profileAutoDetectTitle');
                const courseTitleSelector = profileSection.querySelector('.profileCourseTitleSelector');
                const sessionInfoSelector = profileSection.querySelector('.profileSessionInfoSelector');
                const autoRetryError = profileSection.querySelector('.profileAutoRetryError');
                const errorSelector = profileSection.querySelector('.profileErrorSelector');
                const maxRetryAttempts = profileSection.querySelector('.profileMaxRetryAttempts');
                
                autoDetectEnd.checked = automation.autoDetectEnd || false;
                endDetectionSelector.value = automation.endDetectionSelector || '';
                autoStartPlayback.checked = automation.autoStartPlayback || false;
                playButtonSelector.value = automation.playButtonSelector || '';
                countdownSelector.value = automation.countdownSelector || '';
                autoAdjustSpeed.checked = automation.autoAdjustSpeed || false;
                speedSelector.value = automation.speedSelector || '';
                playbackSpeed.value = automation.playbackSpeed || '2.0';
                autoDetectTitle.checked = automation.autoDetectTitle || false;
                courseTitleSelector.value = automation.courseTitleSelector || '';
                sessionInfoSelector.value = automation.sessionInfoSelector || '';
                autoRetryError.checked = automation.autoRetryError || false;
                errorSelector.value = automation.errorSelector || '';
                maxRetryAttempts.value = automation.maxRetryAttempts || '3';
                
                // Disable delete button for built-in profiles
                const deleteButton = profileSection.querySelector('.btnDeleteProfile');
                if (profile.builtin) {
                    deleteButton.disabled = true;
                    deleteButton.title = "Built-in profiles cannot be deleted";
                } else {
                    deleteButton.addEventListener('click', () => deleteProfile(profileId));
                }
                
                // Add change event to all inputs to mark changes
                const allInputs = profileSection.querySelectorAll('input, select');
                allInputs.forEach(input => {
                    input.addEventListener('change', () => {
                        hasChanges = true;
                    });
                });
                
                // Add to container
                profilesContainer.appendChild(profileSection);
            }
            
            // Create new profile
            function createNewProfile() {
                const name = newProfileName.value.trim();
                if (!name) {
                    alert('Please enter a profile name');
                    return;
                }
                
                // Create unique ID
                const profileId = 'profile_' + Date.now();
                
                // Create new profile with default values
                const newProfile = {
                    name: name,
                    elementSelector: '',
                    urlPattern: '',
                    automation: {
                        autoDetectEnd: false,
                        endDetectionSelector: '',
                        autoStartPlayback: false,
                        playButtonSelector: '',
                        countdownSelector: '',
                        autoAdjustSpeed: false,
                        speedSelector: '',
                        playbackSpeed: '2.0',
                        autoDetectTitle: false,
                        courseTitleSelector: '',
                        sessionInfoSelector: '',
                        autoRetryError: false,
                        errorSelector: '',
                        maxRetryAttempts: '3'
                    }
                };
                
                // Add to profiles object
                profiles[profileId] = newProfile;
                
                // Create UI element
                createProfileSection(profileId, newProfile);
                
                // Clear input field
                newProfileName.value = '';
                
                // Mark changes
                hasChanges = true;
            }
            
            // Delete profile
            function deleteProfile(profileId) {
                if (confirm(`Are you sure you want to delete the profile "${profiles[profileId].name}"?`)) {
                    // Remove UI element
                    const profileSection = document.querySelector(`.profile-section[data-profile-id="${profileId}"]`);
                    if (profileSection) {
                        profilesContainer.removeChild(profileSection);
                    }
                    
                    // Remove data
                    delete profiles[profileId];
                    
                    // Mark changes
                    hasChanges = true;
                }
            }
            
            // Save all profiles
            async function saveAllProfiles() {
                try {
                    // Get current configuration
                    const config = await window.electronAPI.getConfig();
                    
                    // Collect all profile data
                    const profileSections = document.querySelectorAll('.profile-section');
                    for (const section of profileSections) {
                        const profileId = section.dataset.profileId;
                        if (profileId && profiles[profileId]) {
                            const profile = profiles[profileId];
                            
                            // Update basic attributes
                            profile.elementSelector = section.querySelector('.profileElementSelector').value;
                            profile.urlPattern = section.querySelector('.profileUrlPattern').value;
                            
                            // Update automation settings
                            if (!profile.automation) profile.automation = {};
                            profile.automation.autoDetectEnd = section.querySelector('.profileAutoDetectEnd').checked;
                            profile.automation.endDetectionSelector = section.querySelector('.profileEndDetectionSelector').value;
                            profile.automation.autoStartPlayback = section.querySelector('.profileAutoStartPlayback').checked;
                            profile.automation.playButtonSelector = section.querySelector('.profilePlayButtonSelector').value;
                            profile.automation.countdownSelector = section.querySelector('.profileCountdownSelector').value;
                            profile.automation.autoAdjustSpeed = section.querySelector('.profileAutoAdjustSpeed').checked;
                            profile.automation.speedSelector = section.querySelector('.profileSpeedSelector').value;
                            profile.automation.playbackSpeed = section.querySelector('.profilePlaybackSpeed').value;
                            profile.automation.autoDetectTitle = section.querySelector('.profileAutoDetectTitle').checked;
                            profile.automation.courseTitleSelector = section.querySelector('.profileCourseTitleSelector').value;
                            profile.automation.sessionInfoSelector = section.querySelector('.profileSessionInfoSelector').value;
                            profile.automation.autoRetryError = section.querySelector('.profileAutoRetryError').checked;
                            profile.automation.errorSelector = section.querySelector('.profileErrorSelector').value;
                            profile.automation.maxRetryAttempts = section.querySelector('.profileMaxRetryAttempts').value;
                        }
                    }
                    
                    // Update profiles in configuration
                    config.siteProfiles = profiles;
                    
                    // Save configuration
                    await window.electronAPI.saveConfig(config);
                    
                    hasChanges = false;
                    return true;
                } catch (error) {
                    console.error('Failed to save profiles:', error);
                    alert('Failed to save profiles: ' + error.message);
                    return false;
                }
            }
            
            // Bind events
            btnCreateProfile.addEventListener('click', createNewProfile);
            
            // Load data when Profiles tab is displayed
            document.querySelector('.tab[data-tab="profiles"]').addEventListener('click', loadAllProfiles);
            
            // Enhance Save button to save profiles
            btnSave.addEventListener('click', async function() {
                // Check if on Profiles tab
                const profilesTabActive = document.getElementById('profiles-tab').classList.contains('active');
                
                if (profilesTabActive && hasChanges) {
                    await saveAllProfiles();
                }
            });
            
            // Enhance Cancel button to reload profiles
            btnCancel.addEventListener('click', function() {
                const profilesTabActive = document.getElementById('profiles-tab').classList.contains('active');
                
                if (profilesTabActive && hasChanges) {
                    loadAllProfiles();
                    hasChanges = false;
                }
            });
            
            // Initial load of profiles
            if (document.getElementById('profiles-tab').classList.contains('active')) {
                loadAllProfiles();
            }
        });
    </script>
</body>
</html>