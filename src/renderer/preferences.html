<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoSlides Preferences</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
            overflow: hidden; /* Prevent body scrolling */
        }
        
        .preferences-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            max-width: 650px;
            margin: 0 auto;
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .preferences-header {
            background-color: #f9f9f9;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            flex-shrink: 0; /* Prevent shrinking */
        }
        
        .preferences-header h1 {
            margin: 0;
            font-size: 18px;
            font-weight: 500;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #eee;
            background-color: #f9f9f9;
            flex-shrink: 0; /* Prevent shrinking */
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            border-bottom: 2px solid transparent;
        }
        
        .tab.active {
            border-bottom: 2px solid #0078d7;
            color: #0078d7;
            background-color: white;
        }
        
        .tab:hover:not(.active) {
            background-color: #eaeaea;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
        }
        
        .tab-content.active {
            display: block;
        }

        /* Create a scrollable content area */
        .content-scroll-area {
            flex: 1;
            overflow-y: auto;
            position: relative;
        }
        
        .preference-item {
            margin-bottom: 20px;
        }
        
        .preference-item label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }
        
        .preference-item input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        
        .help-text {
            color: #777;
            font-size: 12px;
            margin-top: 5px;
        }

        .preference-item label:has(input[type="checkbox"]) + .help-text {
            margin-left: 24px;
        }
        
        .buttons-container {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 15px 20px;
            background-color: #f9f9f9;
            border-top: 1px solid #eee;
            flex-shrink: 0; /* Prevent shrinking */
            position: sticky;
            bottom: 0;
            z-index: 100;
        }
        
        button {
            padding: 8px 16px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background-color: #f0f0f0;
            cursor: pointer;
        }
        
        button:hover {
            background-color: #e8e8e8;
        }
        
        #btnSave {
            background-color: #0078d7;
            color: white;
            border-color: #0067b8;
        }
        
        #btnSave:hover {
            background-color: #0067b8;
        }
        
        /* For settings that use selects/inputs other than checkboxes */
        .preference-item select,
        .preference-item input[type="number"],
        .preference-item input[type="text"] {
            box-sizing: border-box;
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin-top: 5px;
        }

        /* For labels that don't have checkboxes inside */
        .preference-item label:not(:has(input[type="checkbox"])) {
            display: block;
        }

        /* Placeholder for future categories that may be empty */
        .coming-soon {
            color: #999;
            font-style: italic;
            padding: 20px 0;
            text-align: center;
        }

        .preference-section {
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .preference-section h3 {
            font-size: 16px;
            margin-top: 0;
            margin-bottom: 15px;
            color: #444;
        }
        
        .buttons-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .buttons-group button {
            flex: 1;
            padding: 8px 16px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background-color: #f0f0f0;
            cursor: pointer;
        }
        
        .buttons-group button:hover {
            background-color: #e8e8e8;
        }

        .code-editor-container {
            position: relative;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
            background-color: #f8f8f8;
        }
        
        #blockingRules {
            width: 100%;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            padding: 8px;
            font-size: 12px;
            border: none;
            resize: vertical;
            background-color: #f8f8f8;
            color: #333;
            line-height: 1.5;
            tab-size: 4;
            overflow-x: auto;
            white-space: nowrap;
        }
        
        .rules-buttons {
            display: flex;
            gap: 10px;
        }
        
        .rules-buttons button {
            flex: 1;
        }

        /* Profile tab styles */
        #profiles-tab {
            max-width: 800px; /* Increase width to accommodate two columns */
        }

        .preference-section.built-in-profiles {
            margin-top: 0;
            padding-top: 0;
        }
        .preference-section.profile-creation,
        .preference-section.custom-profiles {
            border-top: none;
        }

        .preference-section.profile-creation {
            margin: 30px 0;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }

        .create-profile-row {
            display: flex;
            align-items: flex-end;
            gap: 15px;
        }

        .create-profile-row .preference-item {
            flex-grow: 1;
            margin-bottom: 0;
        }

        .action-button {
            padding: 8px 16px;
            background-color: #0078d7;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            height: 37px; /* Match the height of input */
        }

        .action-button:hover {
            background-color: #0063b1;
        }

        .profiles-grid {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .profile-card {
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px; /* Reduced from 20px */
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .profile-card.built-in {
            background-color: #f5f7fa;
            border-color: #d0d7e2;
        }

        .profile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px; /* Reduced from 15px */
            padding-bottom: 8px; /* Reduced from 10px */
            border-bottom: 1px solid #eee;
        }

        .profile-header h4 {
            margin: 0;
            font-size: 16px;
            color: #333;
        }

        .profile-delete-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: none;
            background-color: #f0f0f0;
            color: #666;
            cursor: pointer;
            padding: 0;
        }

        .profile-delete-btn:hover {
            background-color: #e74c3c;
            color: white;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px; /* Reduced from 20px */
            margin-bottom: 10px; /* Reduced from 15px */
        }

        /* On smaller screens, stack the grid */
        @media (max-width: 650px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }
        }

        .section-divider {
            border: 0;
            height: 1px;
            background-color: #e0e0e0;
            margin: 12px 0; /* Reduced from 20px */
        }

        .profile-card .preference-item {
            margin-bottom: 8px; /* Reduced from default 20px */
        }

        .profile-card .help-text {
            margin-top: 3px; /* Reduced from 5px */
            font-size: 11px; /* Slightly smaller */
        }

        .default-profile .profile-card {
            background-color: #f0f4fa;
            border-color: #c0d0e4;
            margin-bottom: 20px;
        }
        
        .default-profile .profile-header {
            margin-bottom: 10px;
        }

        .preview-link {
            background: none;
            border: none;
            color: #888;
            font-size: 13px;
            padding: 0;
            cursor: pointer;
            font-weight: normal;
        }
        
        .preview-link:hover {
            color: #0078d7;
            text-decoration: underline;
            background: none;
        }
    </style>
</head>
<body>
    <div class="preferences-container">
        <div class="preferences-header">
            <h1>AutoSlides Preferences</h1>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="general">General</div>
            <div class="tab" data-tab="capture">Capture Strategy</div>
            <div class="tab" data-tab="profiles">Optimization Profiles</div>
            <div class="tab" data-tab="automation">Website Automation</div>
        </div>

        <!-- Add scrollable content area wrapper -->
        <div class="content-scroll-area">
        
            <!-- General Tab -->
            <div class="tab-content active" id="general-tab">
                <div class="preference-item">
                    <label>
                        <input type="checkbox" id="allowBackgroundRunning">
                        Keep running in background
                    </label>
                    <div class="help-text">
                        Prevents the system from sleeping while AutoSlides is running. 
                        Useful for long automated capture sessions.
                    </div>
                </div>
                
                <div class="preference-section">
                    <h3>Cache Management</h3>
                    
                    <div class="preference-item">
                        <label for="cacheCleanInterval">Auto-clean interval (minutes):</label>
                        <input type="number" id="cacheCleanInterval" min="0" max="60" step="5" value="15" />
                        <div class="help-text">Set to 0 to disable auto-cleaning</div>
                    </div>
                    
                    <div class="buttons-group">
                        <button id="btnClearCookies">Clear Cookies</button>
                        <button id="btnClearAll">Clear All Data</button>
                    </div>
                </div>
                <!-- Other general settings will be added here -->
            </div>
            
            <!-- Capture Strategy Tab -->
            <div class="tab-content" id="capture-tab">
                <div class="coming-soon">
                    Capture Strategy settings will appear here in future updates.
                </div>
            </div>
            
            <!-- Optimization Profiles Tab -->
            <div class="tab-content" id="profiles-tab">
                <!-- Default Profile Section - NEW -->
                <div class="preference-section default-profile">
                    <div class="profile-card built-in" data-profile-id="default">
                        <div class="profile-header">
                            <h4 class="profile-name">Default (Full Page)</h4>
                            <button id="btnShowCropGuides" class="preview-link">Preview Crop</button>
                        </div>
                        
                        <p class="help-text">The default profile captures the entire webpage with cropping (apply only to Default profile).</p>
                        
                        <hr class="section-divider">
                        
                        <!-- Cropping Settings Group -->
                        <div class="settings-grid">
                            <div class="preference-item">
                                <label for="inputTopCrop">Top Crop (%):</label>
                                <input type="number" id="inputTopCrop" class="topCropPercent" step="1" min="0" max="40" value="5" />
                            </div>
                            
                            <div class="preference-item">
                                <label for="inputBottomCrop">Bottom Crop (%):</label>
                                <input type="number" id="inputBottomCrop" class="bottomCropPercent" step="1" min="0" max="40" value="5" />
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Built-in Profiles Section -->
                <div class="preference-section built-in-profiles">
                    <div class="profiles-grid">
                        <!-- Built-in profile sections will be added dynamically -->
                    </div>
                </div>
                
                <!-- New Profile Creation (Now in the middle) -->
                <div class="preference-section profile-creation">
                    <div class="create-profile-row">
                        <div class="preference-item">
                            <label for="newProfileName">Create New Profile:</label>
                            <input type="text" id="newProfileName" placeholder="Enter profile name">
                        </div>
                        <button id="btnCreateProfile" class="action-button">Create Profile</button>
                    </div>
                </div>
                
                <!-- Custom Profiles Section -->
                <div class="preference-section custom-profiles">
                    <div class="profiles-grid">
                        <!-- Custom profile sections will be added dynamically -->
                    </div>
                </div>
                
                <!-- Template for profiles -->
                <template id="profileTemplate">
                    <div class="profile-card" data-profile-id="">
                        <div class="profile-header">
                            <h4 class="profile-name"></h4>
                            <button class="profile-delete-btn" title="Delete profile">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                        </div>
                        
                        <!-- Basic Configuration Group -->
                        <div class="settings-grid">
                            <div class="preference-item">
                                <label for="profileElementSelector">Element selector:</label>
                                <input type="text" class="profileElementSelector" placeholder="#video_id_topPlayer_html5_api">
                                <div class="help-text">Only the selected element will be captured</div>
                            </div>
                            
                            <div class="preference-item">
                                <label for="profileUrlPattern">URL patterns:</label>
                                <input type="text" class="profileUrlPattern" placeholder="example.com/video">
                                <div class="help-text">Space-separated patterns to auto-select this profile</div>
                            </div>
                        </div>
                        
                        <hr class="section-divider">
                        
                        <!-- Playback Detection Group -->
                        <div class="settings-grid">
                            <div class="preference-item">
                                <label for="profileEndDetectionSelector">End detection selector:</label>
                                <input type="text" class="profileEndDetectionSelector" placeholder=".player-ended-poster">
                                <div class="help-text">Used when "Auto-detect playback end" is enabled</div>
                            </div>
                            
                            <div class="preference-item">
                                <label for="profilePlayButtonSelector">Play button selector:</label>
                                <input type="text" class="profilePlayButtonSelector" placeholder=".play-button">
                                <div class="help-text">Used when "Auto-start playback" is enabled</div>
                            </div>
                        </div>
                        
                        <div class="settings-grid">
                            <div class="preference-item">
                                <label for="profileCountdownSelector">Countdown selector:</label>
                                <input type="text" class="profileCountdownSelector" placeholder=".countdown">
                                <div class="help-text">Element containing countdown before video starts</div>
                            </div>
                        </div>
                        
                        <hr class="section-divider">
                        
                        <!-- Speed Settings Group -->
                        <div class="settings-grid">
                            <div class="preference-item">
                                <label for="profileSpeedSelector">Speed selector:</label>
                                <input type="text" class="profileSpeedSelector" placeholder="#video_element">
                                <div class="help-text">Used when "Auto-adjust playback speed" is enabled</div>
                            </div>
                            
                            <div class="preference-item">
                                <label for="profilePlaybackSpeed">Default playback speed:</label>
                                <select class="profilePlaybackSpeed">
                                    <option value="1.0">1.0x</option>
                                    <option value="1.5">1.5x</option>
                                    <option value="2.0">2.0x</option>
                                    <option value="2.5">2.5x</option>
                                    <option value="3.0">3.0x</option>
                                    <option value="4.0">4.0x</option>
                                    <option value="5.0">5.0x</option>
                                </select>
                            </div>
                        </div>
                        
                        <hr class="section-divider">
                        
                        <!-- Title Detection Group -->
                        <div class="settings-grid">
                            <div class="preference-item">
                                <label for="profileCourseTitleSelector">Course title selector:</label>
                                <input type="text" class="profileCourseTitleSelector" placeholder=".course-title">
                                <div class="help-text">Used when "Auto-detect title" is enabled</div>
                            </div>
                            
                            <div class="preference-item">
                                <label for="profileSessionInfoSelector">Session info selector:</label>
                                <input type="text" class="profileSessionInfoSelector" placeholder=".session-info">
                            </div>
                        </div>
                        
                        <hr class="section-divider">
                        
                        <!-- Error Handling Group -->
                        <div class="settings-grid">
                            <div class="preference-item">
                                <label for="profileErrorSelector">Error selector:</label>
                                <input type="text" class="profileErrorSelector" placeholder=".error-message">
                                <div class="help-text">Used when "Auto-retry on error" is enabled</div>
                            </div>
                            
                            <div class="preference-item">
                                <label for="profileMaxRetryAttempts">Max retry attempts:</label>
                                <input type="number" class="profileMaxRetryAttempts" min="1" max="10" value="3">
                            </div>
                        </div>
                    </div>
                </template>
            </div> 
            <!-- Website Automation Tab -->
            <div class="tab-content" id="automation-tab">
                <div class="preference-section">
                    <h3>Element Blocking Rules</h3>
                    <p class="help-text">AdGuard-like rules (one per line)</p>
                    <div class="code-editor-container">
                        <textarea id="blockingRules" rows="8" spellcheck="false" wrap="off"></textarea>
                    </div>
                </div>
            </div>

        </div>
        
        <div class="buttons-container">
            <button id="btnDefault">Restore Defaults</button>
            <button id="btnCancel">Cancel</button>
            <button id="btnSave">Save</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Tab switching logic
            const tabs = document.querySelectorAll('.tab');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs and content
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    tab.classList.add('active');
                    
                    // Show corresponding content
                    const tabName = tab.getAttribute('data-tab');
                    document.getElementById(`${tabName}-tab`).classList.add('active');
                });
            });

            // Default rules
            const DEFAULT_RULES = `yanhekt.cn###root > div.app > div.sidebar-open:first-child
yanhekt.cn###root > div.app > div.BlankLayout_layout__kC9f3:last-child > div.ant-spin-nested-loading:nth-child(2) > div.ant-spin-container > div.index_liveWrapper__YGcpO > div.index_userlist__T-6xf:last-child > div.index_staticContainer__z3yt-
yanhekt.cn###ai-bit-shortcut
yanhekt.cn##div#ai-bit-animation-modal`;
            
            // Preference elements
            const allowBackgroundRunning = document.getElementById('allowBackgroundRunning');
            const cacheCleanInterval = document.getElementById('cacheCleanInterval');
            const btnClearCookies = document.getElementById('btnClearCookies');
            const btnClearAll = document.getElementById('btnClearAll');
            const blockingRules = document.getElementById('blockingRules');
            const btnApplyRules = document.getElementById('btnApplyRules');
            const btnResetRules = document.getElementById('btnResetRules');
            const btnSave = document.getElementById('btnSave');
            const btnCancel = document.getElementById('btnCancel');
            const btnDefault = document.getElementById('btnDefault');

            // Enhance the blocking rules text area for code-like behavior
            function enhanceBlockingRulesEditor() {
                // Enable tab key in the textarea (instead of changing focus)
                blockingRules.addEventListener('keydown', function(e) {
                    if (e.key === 'Tab') {
                        e.preventDefault();
                        
                        // Insert a tab character at the cursor position
                        const start = this.selectionStart;
                        const end = this.selectionEnd;
                        
                        this.value = this.value.substring(0, start) + '    ' + this.value.substring(end);
                        
                        // Put the cursor after the tab
                        this.selectionStart = this.selectionEnd = start + 4;
                    }
                });
            }
            
            // Load current preferences
            try {
                const config = await window.electronAPI.getConfig();
                allowBackgroundRunning.checked = config.allowBackgroundRunning || false;
                cacheCleanInterval.value = config.cacheCleanInterval || 15;
                
                // Load blocking rules
                const rules = await window.electronAPI.getBlockingRules();
                blockingRules.value = rules || DEFAULT_RULES;
                enhanceBlockingRulesEditor();
            } catch (error) {
                console.error('Failed to load preferences:', error);
            }

            // Clear cookies handler
            btnClearCookies.addEventListener('click', async () => {
                try {
                    btnClearCookies.disabled = true;
                    const result = await window.electronAPI.clearCookies();
                    btnClearCookies.disabled = false;
                    
                    if (result.success) {
                        alert('Cookies cleared successfully');
                    } else {
                        alert('Failed to clear cookies');
                    }
                } catch (error) {
                    console.error('Error clearing cookies:', error);
                    btnClearCookies.disabled = false;
                    alert('Error clearing cookies: ' + error.message);
                }
            });

            // Clear all data handler
            btnClearAll.addEventListener('click', async () => {
                try {
                    btnClearAll.disabled = true;
                    const result = await window.electronAPI.clearAllData();
                    btnClearAll.disabled = false;
                    
                    if (result.success) {
                        alert('All data cleared successfully');
                    } else {
                        alert('Failed to clear all data');
                    }
                } catch (error) {
                    console.error('Error clearing all data:', error);
                    btnClearAll.disabled = false;
                    alert('Error clearing all data: ' + error.message);
                }
            });
            
            // Save button handler
            btnSave.addEventListener('click', async () => {
            try {
                // Get the current config first
                const config = await window.electronAPI.getConfig();
                
                // Update only the preferences-related settings
                const updatedConfig = {
                    ...config,
                    allowBackgroundRunning: allowBackgroundRunning.checked,
                    cacheCleanInterval: parseInt(cacheCleanInterval.value, 10)
                };
                
                // Save the updated config
                await window.electronAPI.saveConfig(updatedConfig);
                
                // Save blocking rules separately and apply them
                await window.electronAPI.saveBlockingRules(blockingRules.value);
                await window.electronAPI.applyBlockingRules();
                
                // Update background running state
                if (allowBackgroundRunning.checked) {
                    await window.electronAPI.enableBackgroundRunning();
                } else {
                    await window.electronAPI.disableBackgroundRunning();
                }
                
                // Close the window
                window.close();
            } catch (error) {
                console.error('Failed to save preferences:', error);
                alert('Failed to save preferences: ' + error.message);
            }
        });
            
            // Cancel button handler
            btnCancel.addEventListener('click', () => {
                window.close();
            });
            
            // Default button handler
            btnDefault.addEventListener('click', async () => {
                // Set to default values for general settings
                allowBackgroundRunning.checked = false;
                cacheCleanInterval.value = 15;
                blockingRules.value = DEFAULT_RULES;
                
                // If on profiles tab, restore default profiles
                const profilesTabActive = document.getElementById('profiles-tab').classList.contains('active');
                if (profilesTabActive) {
                    // Define default values for built-in profiles
                    const defaultProfiles = {
                        "yanhekt_session": {
                            "name": "YanHeKT Session Player",
                            "elementSelector": "#video_id_topPlayer_html5_api",
                            "urlPattern": "yanhekt.cn/session",
                            "builtin": true,
                            "automation": {
                                "autoDetectEnd": true,
                                "endDetectionSelector": ".player-ended-poster",
                                "autoStartPlayback": true,
                                "playButtonSelector": ".player-mid-button-container button",
                                "countdownSelector": "",
                                "autoAdjustSpeed": false,
                                "speedSelector": "#video_id_mainPlayer_html5_api",
                                "playbackSpeed": "3.0",
                                "autoDetectTitle": true,
                                "courseTitleSelector": ".ant-breadcrumb li:nth-child(2) a",
                                "sessionInfoSelector": ".ant-breadcrumb li:nth-child(3) span",
                                "autoRetryError": true,
                                "errorSelector": ".vjs-errors-dialog",
                                "maxRetryAttempts": "30"
                            }
                        },
                        "yanhekt_live": {
                            "name": "YanHeKT Live Player",
                            "elementSelector": "#video_id_mainPlayer_html5_api",
                            "urlPattern": "yanhekt.cn/live",
                            "builtin": true,
                            "automation": {
                                "autoDetectEnd": true,
                                "endDetectionSelector": ".VideoResult_result__LdbB3",
                                "autoStartPlayback": true,
                                "playButtonSelector": ".player-mid-button-container button",
                                "countdownSelector": ".countdown-content",
                                "autoAdjustSpeed": false,
                                "speedSelector": "#video_id_mainPlayer_html5_api",
                                "playbackSpeed": "1.0",
                                "autoDetectTitle": true,
                                "courseTitleSelector": ".index_liveHeader__uN3uM",
                                "sessionInfoSelector": "",
                                "autoRetryError": true,
                                "errorSelector": ".vjs-errors-dialog",
                                "maxRetryAttempts": "3"
                            }
                        }
                    };
                    
                    // Get current config to preserve custom profiles
                    try {
                        const config = await window.electronAPI.getConfig();
                        const currentProfiles = config.siteProfiles || {};
                        
                        // Reset built-in profiles while preserving custom ones
                        for (const [id, profile] of Object.entries(defaultProfiles)) {
                            profiles[id] = profile;
                        }
                        
                        // Preserve custom profiles
                        for (const [id, profile] of Object.entries(currentProfiles)) {
                            if (!profile.builtin && id !== 'default') {
                                profiles[id] = profile;
                            }
                        }
                        
                        // Clear existing profiles containers
                        document.querySelector('.built-in-profiles .profiles-grid').innerHTML = '';
                        document.querySelector('.custom-profiles .profiles-grid').innerHTML = '';
                        
                        // Recreate UI for all profiles
                        for (const [id, profile] of Object.entries(profiles)) {
                            if (id !== 'default') {
                                createProfileSection(id, profile);
                            }
                        }
                        
                        // Mark as changed
                        hasChanges = true;
                        
                    } catch (error) {
                        console.error('Failed to restore default profiles:', error);
                        alert('Failed to restore default profiles: ' + error.message);
                    }
                }
            });

            // Profiles related elements
            const profilesContainer = document.getElementById('profilesContainer');
            const profileTemplate = document.getElementById('profileTemplate');
            const newProfileName = document.getElementById('newProfileName');
            const btnCreateProfile = document.getElementById('btnCreateProfile');
            
            // Global buttons
            const btnRestoreDefaults = document.getElementById('btnRestoreDefaults');
            
            let profiles = {};
            let hasChanges = false;
            
            // Load all profiles from configuration
            async function loadAllProfiles() {
                try {
                    const config = await window.electronAPI.getConfig();
                    profiles = config.siteProfiles || {};
                    
                    // Clear existing profiles containers
                    document.querySelector('.built-in-profiles .profiles-grid').innerHTML = '';
                    document.querySelector('.custom-profiles .profiles-grid').innerHTML = '';
                    
                    // Create UI for each non-default profile
                    for (const [id, profile] of Object.entries(profiles)) {
                        if (id !== 'default') {
                            createProfileSection(id, profile);
                        }
                    }
                } catch (error) {
                    console.error('Failed to load profiles:', error);
                    alert('Failed to load profiles: ' + error.message);
                }
            }
            
            // Create settings section for a single profile          
            function createProfileSection(profileId, profile) {
                // Clone template
                const profileSection = profileTemplate.content.cloneNode(true).querySelector('.profile-card');
                
                // Set profile ID
                profileSection.dataset.profileId = profileId;
                
                // Add class for built-in profiles
                if (profile.builtin) {
                    profileSection.classList.add('built-in');
                }
                
                // Set profile name
                const profileName = profileSection.querySelector('.profile-name');
                profileName.textContent = profile.name || profileId;
                
                // Set basic attributes
                const elementSelector = profileSection.querySelector('.profileElementSelector');
                const urlPattern = profileSection.querySelector('.profileUrlPattern');
                elementSelector.value = profile.elementSelector || '';
                urlPattern.value = profile.urlPattern || '';
                
                // Set automation attributes
                const automation = profile.automation || {};
                const endDetectionSelector = profileSection.querySelector('.profileEndDetectionSelector');
                const playButtonSelector = profileSection.querySelector('.profilePlayButtonSelector');
                const countdownSelector = profileSection.querySelector('.profileCountdownSelector');
                const speedSelector = profileSection.querySelector('.profileSpeedSelector');
                const playbackSpeed = profileSection.querySelector('.profilePlaybackSpeed');
                const courseTitleSelector = profileSection.querySelector('.profileCourseTitleSelector');
                const sessionInfoSelector = profileSection.querySelector('.profileSessionInfoSelector');
                const errorSelector = profileSection.querySelector('.profileErrorSelector');
                const maxRetryAttempts = profileSection.querySelector('.profileMaxRetryAttempts');
                
                endDetectionSelector.value = automation.endDetectionSelector || '';
                playButtonSelector.value = automation.playButtonSelector || '';
                countdownSelector.value = automation.countdownSelector || '';
                speedSelector.value = automation.speedSelector || '';
                playbackSpeed.value = automation.playbackSpeed || '2.0';
                courseTitleSelector.value = automation.courseTitleSelector || '';
                sessionInfoSelector.value = automation.sessionInfoSelector || '';
                errorSelector.value = automation.errorSelector || '';
                maxRetryAttempts.value = automation.maxRetryAttempts || '3';
                
                // Hide delete button for built-in profiles
                const deleteButton = profileSection.querySelector('.profile-delete-btn');
                if (profile.builtin) {
                    deleteButton.style.display = 'none';
                } else {
                    deleteButton.addEventListener('click', () => deleteProfile(profileId));
                }
                
                // Add change event to all inputs to mark changes
                const allInputs = profileSection.querySelectorAll('input, select');
                allInputs.forEach(input => {
                    input.addEventListener('change', () => {
                        hasChanges = true;
                    });
                });
                
                // Add to appropriate container
                if (profile.builtin) {
                    document.querySelector('.built-in-profiles .profiles-grid').appendChild(profileSection);
                } else {
                    document.querySelector('.custom-profiles .profiles-grid').appendChild(profileSection);
                }
            }
            
            // Create new profile
            function createNewProfile() {
                const name = newProfileName.value.trim();
                if (!name) {
                    alert('Please enter a profile name');
                    return;
                }
                
                // Create unique ID
                const profileId = 'profile_' + Date.now();
                
                // Create new profile with default values
                const newProfile = {
                    name: name,
                    elementSelector: '',
                    urlPattern: '',
                    automation: {
                        // No boolean flags here, only configuration values
                        endDetectionSelector: '',
                        playButtonSelector: '',
                        countdownSelector: '',
                        speedSelector: '',
                        playbackSpeed: '2.0',
                        courseTitleSelector: '',
                        sessionInfoSelector: '',
                        errorSelector: '',
                        maxRetryAttempts: '3'
                    }
                };
                
                // Add to profiles object
                profiles[profileId] = newProfile;
                
                // Create UI element
                createProfileSection(profileId, newProfile);
                
                // Clear input field
                newProfileName.value = '';
                
                // Mark changes
                hasChanges = true;
            }
            
            // Delete profile
            function deleteProfile(profileId) {
                if (confirm(`Are you sure you want to delete the profile "${profiles[profileId].name}"?`)) {
                    // Fix the selector - use profile-card instead of profile-section
                    const profileCard = document.querySelector(`.profile-card[data-profile-id="${profileId}"]`);
                    if (profileCard) {
                        // Find the correct parent container
                        profileCard.parentNode.removeChild(profileCard);
                    }
                    
                    // Remove data
                    delete profiles[profileId];
                    
                    // Mark changes
                    hasChanges = true;
                }
            }
            
            async function saveAllProfiles() {
                try {
                    // Get current config
                    const config = await window.electronAPI.getConfig();
                    const currentProfiles = config.siteProfiles || {};
                    
                    // FIXED SELECTOR: Use .profile-card instead of .profile-section
                    const profileCards = document.querySelectorAll('.profile-card');
                    for (const card of profileCards) {
                        const profileId = card.dataset.profileId;
                        if (profileId && profiles[profileId]) {
                            const profile = profiles[profileId];
                            
                            // Update basic attributes
                            profile.elementSelector = card.querySelector('.profileElementSelector').value;
                            profile.urlPattern = card.querySelector('.profileUrlPattern').value;
                            
                            // Initialize or get existing automation object
                            if (!profile.automation) profile.automation = {};
                            
                            // Get the current automation settings that might have checkbox states
                            const currentAutomation = currentProfiles[profileId]?.automation || {};
                            
                            // Preserve checkbox states from current config if they exist
                            profile.automation.autoDetectEnd = currentAutomation.autoDetectEnd || false;
                            profile.automation.autoStartPlayback = currentAutomation.autoStartPlayback || false;
                            profile.automation.autoAdjustSpeed = currentAutomation.autoAdjustSpeed || false;
                            profile.automation.autoDetectTitle = currentAutomation.autoDetectTitle || false;
                            profile.automation.autoRetryError = currentAutomation.autoRetryError || false;
                            
                            // Update configuration fields (not checkbox states)
                            profile.automation.endDetectionSelector = card.querySelector('.profileEndDetectionSelector').value;
                            profile.automation.playButtonSelector = card.querySelector('.profilePlayButtonSelector').value;
                            profile.automation.countdownSelector = card.querySelector('.profileCountdownSelector').value;
                            profile.automation.speedSelector = card.querySelector('.profileSpeedSelector').value;
                            profile.automation.playbackSpeed = card.querySelector('.profilePlaybackSpeed').value;
                            profile.automation.courseTitleSelector = card.querySelector('.profileCourseTitleSelector').value;
                            profile.automation.sessionInfoSelector = card.querySelector('.profileSessionInfoSelector').value;
                            profile.automation.errorSelector = card.querySelector('.profileErrorSelector').value;
                            profile.automation.maxRetryAttempts = card.querySelector('.profileMaxRetryAttempts').value;
                        }
                    }
                    
                    // Update profiles in configuration
                    config.siteProfiles = profiles;
                    
                    // Save configuration
                    await window.electronAPI.saveConfig(config);
                    
                    // Send a message to the main window to update profile dropdown
                    await window.electronAPI.sendToMainWindow('update-profiles', profiles);
                    
                    hasChanges = false;
                    return true;
                } catch (error) {
                    console.error('Failed to save profiles:', error);
                    alert('Failed to save profiles: ' + error.message);
                    return false;
                }
            }
            
            // Bind events
            btnCreateProfile.addEventListener('click', createNewProfile);
            
            // Load data when Profiles tab is displayed
            document.querySelector('.tab[data-tab="profiles"]').addEventListener('click', loadAllProfiles);
            
            // Enhance Save button to save profiles
            btnSave.addEventListener('click', async function() {
                // Check if on Profiles tab
                const profilesTabActive = document.getElementById('profiles-tab').classList.contains('active');
                
                if (profilesTabActive && hasChanges) {
                    await saveAllProfiles();
                }
            });
            
            // Enhance Cancel button to reload profiles
            btnCancel.addEventListener('click', function() {
                const profilesTabActive = document.getElementById('profiles-tab').classList.contains('active');
                
                if (profilesTabActive && hasChanges) {
                    loadAllProfiles();
                    hasChanges = false;
                }
            });
            
            // Initial load of profiles
            if (document.getElementById('profiles-tab').classList.contains('active')) {
                loadAllProfiles();
            }

            // Default profile crop settings
            const inputTopCrop = document.getElementById('inputTopCrop');
            const inputBottomCrop = document.getElementById('inputBottomCrop');
            const btnShowCropGuides = document.getElementById('btnShowCropGuides');
            
            // Load crop settings from config
            async function loadCropSettings() {
                try {
                    const config = await window.electronAPI.getConfig();
                    inputTopCrop.value = config.topCropPercent || 5;
                    inputBottomCrop.value = config.bottomCropPercent || 5;
                } catch (error) {
                    console.error('Failed to load crop settings:', error);
                }
            }
            
            // Show crop guides button handler
            btnShowCropGuides.addEventListener('click', async () => {
                try {
                    // Save current crop settings first
                    const config = await window.electronAPI.getConfig();
                    config.topCropPercent = parseFloat(inputTopCrop.value);
                    config.bottomCropPercent = parseFloat(inputBottomCrop.value);
                    await window.electronAPI.saveConfig(config);
                    
                    // Tell main window to show crop guides
                    await window.electronAPI.sendToMainWindow('show-crop-guides');
                } catch (error) {
                    console.error('Failed to show crop guides:', error);
                    alert('Failed to show crop guides: ' + error.message);
                }
            });
            
            // Mark changes and show real-time preview when crop settings change
            inputTopCrop.addEventListener('input', async () => {
                hasChanges = true;
                await updateCropPreviewInMainWindow();
            });
            
            inputBottomCrop.addEventListener('input', async () => {
                hasChanges = true;
                await updateCropPreviewInMainWindow();
            });
            
            // Focus events to show crop guides
            inputTopCrop.addEventListener('focus', async () => {
                await updateCropPreviewInMainWindow();
            });
            
            inputBottomCrop.addEventListener('focus', async () => {
                await updateCropPreviewInMainWindow();
            });
            
            // Helper function to update crop preview in main window
            async function updateCropPreviewInMainWindow() {
                try {
                    // Send current values directly to main window without saving to config
                    await window.electronAPI.sendToMainWindow('update-crop-preview', {
                        topCropPercent: parseFloat(inputTopCrop.value) || 0,
                        bottomCropPercent: parseFloat(inputBottomCrop.value) || 0
                    });
                } catch (error) {
                    console.error('Failed to update crop preview:', error);
                }
            }
            
            // Load crop settings when Profiles tab is displayed
            document.querySelector('.tab[data-tab="profiles"]').addEventListener('click', () => {
                loadCropSettings();
                // Also load profiles (existing functionality)
                if (typeof loadAllProfiles === 'function') {
                    loadAllProfiles();
                }
            });
            
            // Enhance save button to also save crop settings
            const originalSaveHandler = btnSave.onclick;
            btnSave.onclick = async function() {
                const profilesTabActive = document.getElementById('profiles-tab').classList.contains('active');
                
                if (profilesTabActive) {
                    try {
                        // Save crop settings
                        const config = await window.electronAPI.getConfig();
                        config.topCropPercent = parseFloat(inputTopCrop.value);
                        config.bottomCropPercent = parseFloat(inputBottomCrop.value);
                        await window.electronAPI.saveConfig(config);
                    } catch (error) {
                        console.error('Failed to save crop settings:', error);
                        alert('Failed to save crop settings: ' + error.message);
                        return;
                    }
                }
                
                // Call original save handler for other settings
                if (originalSaveHandler) {
                    return originalSaveHandler.call(this);
                }
            };
            
            // Also restore crop settings when defaults are restored
            const enhanceResetDefaults = btnDefault.onclick;
            btnDefault.addEventListener('click', async function() {
                const profilesTabActive = document.getElementById('profiles-tab').classList.contains('active');
                
                if (profilesTabActive) {
                    // Reset crop settings to defaults
                    inputTopCrop.value = 5;
                    inputBottomCrop.value = 5;
                    hasChanges = true;
                }
                
                // Call original handler
                if (enhanceResetDefaults) {
                    return enhanceResetDefaults.call(this);
                }
            });
            
            // Initial load if profiles tab is active
            if (document.getElementById('profiles-tab').classList.contains('active')) {
                loadCropSettings();
            }
        });
    </script>
</body>
</html>